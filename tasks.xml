<?xml version="1.0"?>

<project>

	<!-- Load build properties -->
	<property file="./build.properties"/>

	<!-- Create classpath -->
	<path id="classpath">
		<pathelement location="${classDir}"/>
		<pathelement location="${configDir}"/>
		<pathelement location="lib/mixup"/>
		<fileset dir="${libDir}">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<!-- Initalization -->
	<target name="init">
		<!-- Create the time stamp -->
		<tstamp/>
		<!-- Create the build directory structure used by build -->
		<mkdir dir="${classDir}"/>
	</target>

	<!-- Compile the java code from ${srcDir} into ${classDir} -->
	<target name="build" depends="init" description="build source">
		<javac source="1.5" srcdir="${srcDir}" destdir="${classDir}" verbose="${verbose}" debug="on" classpathref="classpath" deprecation="${deprecation}"/>
	</target>
	
	<!-- Delete the ${classDir}, ${dist}, and other directory trees -->
	<target name="clean" description="clean up">
		<delete dir="${classDir}"/>
		<delete dir="${reportsDir}"/>
		<delete dir="${tmpDir}"/>
	</target>
	
	<!-- Clean build -->
	<target name="build-clean" depends="clean,build" description="compile the source from scratch">
	</target>

	<!-- Copy test cases into class dir for JUnit tests -->
	<target name="copy-testcases" description="copy files from testcase directory into class directory">
		<copy todir="${classDir}">
			<fileset dir="test" includes="**/testcases/**"/>
		</copy>
	</target>
	
	<!-- Build JUnit tests -->
	<target name="build-test" depends="init,build,copy-testcases" description="compile test cases">
		<javac srcdir="${testDir}" destdir="${classDir}" 
   debug="on" classpathref="classpath" deprecation="${deprecation}"/>
	</target>

	<target name="build-tests" depends="build-test" description="alias for build-test"/>

	<!-- Open jar files for building dist -->
	<target name="open-jars" depends="build" description="unpack lib/*.jar into a tmp directory">
		<delete dir="${tmpDir}"/>
		<mkdir dir="${tmpDir}"/>
		<unjar dest="${tmpDir}">
			<fileset dir="${libDir}" includes="*.jar" excludes="minorThirdIncludes.jar"/>
		</unjar>
	</target>

	<!-- Merge jar files for building dist -->
	<target name="merge-jars" depends="open-jars" description="merge lib/*.jar into a single jar file">
		<jar jarfile="minorThirdIncludes.jar" baseDir="${tmpDir}">
			<fileset dir="${tmpDir}" includes="**/*.class"/>
		</jar>
	</target>

	<!-- Build distribution jar file -->
	<target name="dist" description="generate the distribution" depends="open-jars">
		<mkdir dir="${distDir}"/>
		<!-- Put everything in ${classDir} into the minorThird-${DSTAMP}.jar file -->
		<jar jarfile="${distDir}/minorThird-${DSTAMP}.jar" basedir="${classDir}">
			<manifest>
				<attribute name="Main-Class" value="edu.cmu.minorthird.Minorthird"/>
			</manifest>
			<fileset dir="${classDir}">
				<include name="edu/cmu/minorthird/**.class"/>
			</fileset>
			<!-- Why include tmpDir? -->
			<fileset dir="${tmpDir}" includes="**/*"/>
			<fileset dir="${configDir}">
				<include name="*.properties"/>
				<include name="*.config"/>
				<include name="selectableTypes.txt"/>
			</fileset>
			<fileset dir="${libDir}">
				<include name="**/*.mixup"/>
				<include name="montylingua/*"/>
				<include name="org.*"/>
				<include name="org/*"/>
			</fileset>
		</jar>
		<copy file="${distDir}/minorThird-${DSTAMP}.jar" toFile="${distDir}/minorThird.jar"/>
	</target>

	<target name="jar" depends="dist" description="alias for 'dist'"/>
	
	<!-- Build nice JavaDoc -->
	<target name="javadoc" description="rebuild java docs">
		<delete dir="${javadocDir}"/>
		<mkdir dir="${javadocDir}/edu/cmu/minorthird/"/>
		<javadoc sourcepath="${srcDir}" destdir="${javadocDir}" 
   classpathref="classpath" packagenames="edu.cmu.minorthird.*"/>
	</target>
	
	<target name="javadocs" depends="javadoc" description="alias for ant javadocs"/>

	<!-- Run (not build) JUnit tests -->
	<target name="test" depends="build,build-test" description="run the tests, NOT halting on failure">
		<mkdir dir="${reportsDir}"/>
		<!-- Apparently the maxmemory doesn't help to increase heap space. Ideas? -->
		<junit maxmemory="2048m" printsummary="yes" haltonfailure="no">
			<classpath>
				<path refid="classpath"/>
			</classpath>
			<formatter type="plain"/>
			<batchtest fork="no" todir="${reportsDir}">
				<fileset dir="${classDir}">
					<!-- either TestPackage or *Test -->
					<include name="**/TestPackage.class"/>
					<include name="**/*Test.class"/>
					<!-- exclude LongTestPackage because it takes up too much time -->
					<exclude name="**/LongTestPackage.class"/>
					<!-- inner classes excluded -->
					<exclude name="**/*$*.class"/>
					<!-- a base class, not to be run, unfortunately named -->
					<exclude name="edu/cmu/minorthird/text/learn/ClassifyTest.class"/>
					<!-- requires test data -->
					<exclude name="**/IOUtilTest.class"/>
					<!-- data -->
					<exclude name="**/classify/Test.class"/>
					<exclude name="**/classify/TrainTest.class"/>
					<exclude name="**/LearnToClassifyTest.class"/>
					<exclude name="**/EdoTextLabelsTest.class"/>
					<exclude name="**/BayesClassifiersTest.class"/>
					<exclude name="**/TextLabelsLoaderTest.class"/>
					<exclude name="**/SimpleTextLoaderTest.class"/>
					<exclude name="com/lgc/wsh/inv/GaussNewtonSolverTest.class"/>
				</fileset>
			</batchtest>
		</junit>
		<!-- Delete temporary files -->
		<delete file="./tmp.ann"/>
	</target>

	<target name="tests" depends="test" description="alias for test"/>

	<!-- Longer JUnit tests -->
	<target name="long-test" depends="build,build-test" description="Run the tests, NOT halting on failure">
		<mkdir dir="${reportsDir}"/>
		<junit printsummary="yes" haltonfailure="no"> 
    <classpath><path refid="classpath"/></classpath>
			<formatter type="plain"/>
			<batchtest fork="no" todir="${reportsDir}">
				<fileset dir="${classDir}">
					<include name="**/LongTestPackage.class"/>
				</fileset>
			</batchtest>
		</junit>
	</target>
	
	<target name="long-tests" depends="long-test" description="alias for long-test"/>
	
	<!-- Some app-building task -->
	<target name="build-apps" depends="build" description="build the source for the app directory">
		<javac srcdir="apps/" destdir="${classDir}" debug="on" classpathref="classpath"/>
	</target>
	
	<!-- More app-building task -->
	<target name="build-names" depends="init" description="build the source for app/names">
		<javac srcdir="./apps/names/src" destdir="${classDir}" debug="on" classpathref="classpath"/>
	</target>
	
</project>